version: 2

jobs:
  build:
    docker:
      - image: dramforever/os-lectures-build
    steps:
      - checkout
      - run:
          name: Update repo.json
          command: |
            /root/.nix-profile/bin/nix run nixpkgs.nix-prefetch-git -c \
              nix-prefetch-git --url "https://github.com/LearningOS/os-lectures.git" > repo.json

      - run:
          name: Build
          command: |
            /root/.nix-profile/bin/nix-build

      - run:
          name: Copy artifacts
          command: cp -rH result output

      - run:
          name: Release
          command: |
            apk add hub

            files=()

            for i in output/*.pdf; do
              files+=(-a "$i")
            done

            hub release create "${files[@]}" -m "" $(date +"%Y-%m-%d")

      - store_artifacts:
          path: output
          desination: /
